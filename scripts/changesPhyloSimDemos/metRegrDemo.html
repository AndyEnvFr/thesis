<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="A.I.">

<title>Quantification of stabilizing CDD</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="metRegrDemo_files/libs/clipboard/clipboard.min.js"></script>
<script src="metRegrDemo_files/libs/quarto-html/quarto.js"></script>
<script src="metRegrDemo_files/libs/quarto-html/popper.min.js"></script>
<script src="metRegrDemo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="metRegrDemo_files/libs/quarto-html/anchor.min.js"></script>
<link href="metRegrDemo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="metRegrDemo_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="metRegrDemo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="metRegrDemo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="metRegrDemo_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Quantification of stabilizing CDD</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>A.I. </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PhyloSim)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(metafor)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># root &lt;- "~/Uni/Master/MA/" # work from local machine</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>root <span class="ot">&lt;-</span> <span class="st">"~/cyber_synch/"</span> <span class="co"># work from uni bayreuth server</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Abbreviations<br>
[n,p]DD = [neagitve, positive] density dependence</p>
<p>What does stabilizing CDD mean in my thesis ?<br>
I quantified stabilizng CDD similar to HÃ¼lsmann et al.&nbsp;(2024.) It is defined as the increase in the probability of mortality with the addition of one conspecific neighbor. I will walk you through the step-by-step process of adapting the analysis pipeline, initially designed for empirical data, to my simulated data. This script is based on XXXXX tutorial.</p>
<section id="workflow" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Workflow</h1>
<p>To get an overview of the workflow, here the main step:</p>
<ul>
<li>load the simulations</li>
<li>detect the number of conspecific neighbors for all individuals</li>
<li>convert result matrices to tabular data</li>
<li>for each run extract species wise information (conspecific neighbors and species abundance) Now we have species wise information. The next steps are applied to each species of each run.</li>
<li>run a binomial glm with mortality chance as response and conspecific neighbors as predictors</li>
<li>extract the coefficients and variance-covariance matrix (=vcov) for all species</li>
<li>simulate new coefficients based on the extracted one and the vcov with the <code>MASS::mvrnorm()</code> function</li>
<li>based on that simulations i predict and average the increase in mortality chance with the addition of one conspecific neighbor. This is the <em>stabilizing CDD</em>
<ul>
<li>by averaging after predicting from simulations I account for the non-linear predictions resulting from the sigmoidal logit link function of the binomial glm</li>
</ul></li>
<li>with the <code>metafor::rma()</code> function I run the meta regression with the species abundance as moderator variable, correcting for uncertainty differences between different species abundances</li>
<li>visualization of the resulting regressions and further plots</li>
</ul>
</section>
<section id="data-preparation-and-explanation" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data preparation and explanation</h1>
<p>The runs that I load are generated with a random sampling of the nDD and pDD strength, specificity kernel, and spatial kernel.<br>
The strength is a simple scalar that ranges from 0 to 1. For details on the specificity kernel see XXXXX. In a first step, I present the spatial kernel (param = densityCut).</p>
<section id="the-spatial-kernel-parameter-densitycut" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="the-spatial-kernel-parameter-densitycut"><span class="header-section-number">2.1</span> The spatial kernel (parameter = densityCut)</h2>
<section id="visualization-and-mathematical-definition" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="visualization-and-mathematical-definition"><span class="header-section-number">2.1.1</span> visualization and mathematical definition</h3>
<p>The parameter for the spatial kernel is named <em>nDensityCut</em> or <em>pDensityCut</em>, depending on which DD effect it refers to. The provided value is used as the <em>radius</em> to generate a circular neighborhood around the focal cell. Neighbors within this radius exert a density-dependent (DD) effect on the focal cell. While the overall net effect remains constant, increasing the size of the neighborhood causes the DD effect from each individual neighbor to be spread out among the new neighbors. As a result, the net effect remains unchanged, but the influence of each individual neighbor is diluted.</p>
<p>The next chunk shows a function that can be used to asses the neighborhood of different radii.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>plot_combined_neighborhoods <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">radii =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>), <span class="at">matrix_size =</span> <span class="dv">10</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create matrix filled with zeros</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> matrix_size, <span class="at">ncol =</span> matrix_size)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find center position</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  center_x <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(matrix_size <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  center_y <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(matrix_size <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mark center cell with highest value</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  mat[center_x, center_y] <span class="ot">&lt;-</span> <span class="fu">length</span>(radii) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process each radius (from smallest to largest to show innermost radius)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (r_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(radii)) {</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    radius <span class="ot">&lt;-</span> radii[r_idx]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    offsets <span class="ot">&lt;-</span> <span class="fu">getCircularOffsets</span>(radius)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark neighbor cells for this radius</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(offsets)) {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      neighbor_x <span class="ot">&lt;-</span> center_x <span class="sc">+</span> offsets<span class="sc">$</span>dx[i]</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      neighbor_y <span class="ot">&lt;-</span> center_y <span class="sc">+</span> offsets<span class="sc">$</span>dy[i]</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Check if neighbor is within matrix bounds</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (neighbor_x <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> neighbor_x <span class="sc">&lt;=</span> matrix_size <span class="sc">&amp;&amp;</span> </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>          neighbor_y <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> neighbor_y <span class="sc">&lt;=</span> matrix_size) {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Always mark with current radius (innermost radius takes priority)</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        mat[neighbor_x, neighbor_y] <span class="ot">&lt;-</span> r_idx</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create custom color palette</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"white"</span>,<span class="st">"black"</span>, <span class="st">"darkgrey"</span>, <span class="st">"lightgrey"</span>, <span class="st">"red"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 0=white (empty), 1=lightblue (radius 1), 2=lightgreen (radius 3), </span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3=orange (radius 5), 4=red (center)</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot using image function</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image</span>(<span class="dv">1</span><span class="sc">:</span>matrix_size, <span class="dv">1</span><span class="sc">:</span>matrix_size, mat, </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> colors[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(radii) <span class="sc">+</span> <span class="dv">2</span>)],</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"X coordinate"</span>, </span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Y coordinate"</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">axes =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add grid lines</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span><span class="sc">:</span>matrix_size <span class="sc">-</span> <span class="fl">0.5</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">1</span><span class="sc">:</span>matrix_size <span class="sc">-</span> <span class="fl">0.5</span>, <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="fl">0.3</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create legend</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  legend_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"Radius"</span>, radii), <span class="st">"Center"</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  legend_colors <span class="ot">&lt;-</span> colors</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, </span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">legend =</span> legend_labels, </span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> legend_colors[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(legend_colors)], </span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate and print neighbor counts for each radius</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  neighbor_counts <span class="ot">&lt;-</span> <span class="fu">sapply</span>(radii, <span class="cf">function</span>(r) <span class="fu">nrow</span>(<span class="fu">getCircularOffsets</span>(r)))</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">matrix =</span> mat, <span class="at">neighbor_counts =</span> neighbor_counts))</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset plotting parameters and create single plot</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>))</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot combined neighborhoods</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>result_combined <span class="ot">&lt;-</span> <span class="fu">plot_combined_neighborhoods</span>(<span class="at">radii =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">1</span>), <span class="at">matrix_size =</span> <span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-neigh_radius" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-neigh_radius-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="metRegrDemo_files/figure-html/fig-neigh_radius-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-neigh_radius-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Visualization of circular neighborhood structure for radii 1, 3, and 5.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The circular neighborhood with a given radius ( r ) can be expressed as:</p>
<p>For each <span class="math inline">\(i = -r\)</span> to <span class="math inline">\(r\)</span>:<br>
<span class="math display">\[
\quad y_{\text{Lim}} = \left\lfloor \sqrt{r^2 - i^2} \right\rfloor\\
\]</span> For each <span class="math inline">\(i\)</span> the vertical offset <span class="math inline">\(j\)</span> ranges from <span class="math inline">\(-y_{\text{Lim}}\)</span> to <span class="math inline">\(y_{\text{Lim}}\)</span>.<br>
The total number of cells within the circular neighborhood, excluding the focal cell at the center, is given by:</p>
<p><span class="math display">\[
\sum_{i=-r}^{r} \sum_{j=-y_{\text{Lim}}}^{y_{\text{Lim}}} 1, \quad \text{except for} \quad (i=0, j=0)
\]</span></p>
<p>Where:</p>
<ul>
<li><p><span class="math inline">\(r\)</span> is the radius of the circular neighborhood</p></li>
<li><p><span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> represent the horizontal and vertical offsets from the central cell</p></li>
<li><p><span class="math inline">\(y_{\text{Lim}}\)</span> is the vertical offset limit for each horizontal offset <span class="math inline">\(i\)</span></p></li>
<li><p>The focal cell <span class="math inline">\((i=0, j=0)\)</span> is excluded from the count</p></li>
</ul>
<p>To easily count the neighbors within R, you can combine the <code>PhyloSim::getCircularOffsets()</code> function with the <code>nrow()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getCircularOffsets</span>(<span class="at">radius =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  dx dy
1 -1  0
2  0 -1
3  0  1
4  1  0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>nbR1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">getCircularOffsets</span>(<span class="at">radius =</span> <span class="dv">1</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>nbR5 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">getCircularOffsets</span>(<span class="at">radius =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If the spatial kernel (i.e., densityCut) is set to 1, the focal cell has 4 neighbors. With radius = 5, the focal cell has 80 neighbors.</p>
</section>
<section id="the-spatial-kernel-in-the-simulations" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="the-spatial-kernel-in-the-simulations"><span class="header-section-number">2.1.2</span> The spatial kernel in the simulations</h3>
<p>Below, I show that the spatial kernel (i.e., densityCut) varies within a specific batch. A batch is a grouping of runs computed parallel.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load in runs with</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>runsRaw <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(root, <span class="st">"/local/runs/mstr/20250903/ranRuns_i.rds"</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check maximum densityCut value</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">sapply</span>(runsRaw, <span class="cf">function</span>(x){</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">unique</span>(x<span class="sc">$</span>Model<span class="sc">$</span>nDensityCut, x<span class="sc">$</span>Model<span class="sc">$</span>pDensityCut)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The batch contains the following densityCut values: 1, 2, 3, 4, 5, indicating that nDD or pDD has a variable spatial extent across runs. This is important for our regression method, where the number of conspecific neighbors serves as a predictor. To ensure comparability across the 50 runs in the batch, we use the largest spatial kernel observed in the batch for all runs (XXXXX explains why). The maximum value in our batch is 5. Thus, even if a run has nDensityCut = 1 and pDensityCut = 2, we expand the radius for counting conspecific neighbors to 5.</p>
</section>
</section>
<section id="assessing-conspecific-neighbors-and-mortalities" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="assessing-conspecific-neighbors-and-mortalities"><span class="header-section-number">2.2</span> Assessing conspecific neighbors and mortalities</h2>
<p>Having determined the maximum spatial kernel, we use it to define the neighborhood radius within which conspecific neighbors are counted. The function below does this.</p>
<p>Structure of runs before counting conspecific neighbors: specMat, traitMat, envMat, compMat, neutMat, summaries</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>runsCon  <span class="ot">&lt;-</span> <span class="fu">getConNeigh</span>(runsRaw, <span class="at">radius =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Structure of runs before counting conspecific neighbors: specMat, traitMat, envMat, compMat, neutMat, summaries, mortMat, idMat, conNeighMat</p>
<p>The process added a matrix of conspecific neighbors and a mortality matrix, both shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>),  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.6</span>,<span class="fl">0.6</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>))  </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(runsCon[[<span class="dv">1</span>]]<span class="sc">$</span>Output<span class="sc">$</span><span class="st">`</span><span class="at">90001</span><span class="st">`</span><span class="sc">$</span>specMat, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(runsCon[[<span class="dv">1</span>]]<span class="sc">$</span>Output<span class="sc">$</span><span class="st">`</span><span class="at">90001</span><span class="st">`</span><span class="sc">$</span>conNeighMat, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(runsCon[[<span class="dv">1</span>]]<span class="sc">$</span>Output<span class="sc">$</span><span class="st">`</span><span class="at">90001</span><span class="st">`</span><span class="sc">$</span>mortMat, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(runsCon[[<span class="dv">1</span>]]<span class="sc">$</span>Output<span class="sc">$</span><span class="st">`</span><span class="at">90000</span><span class="st">`</span><span class="sc">$</span>mortMat, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"x-dimensions"</span>, </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">side =</span> <span class="dv">1</span>, </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">outer =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">line =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"y-dimensions"</span>, </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">side =</span> <span class="dv">2</span>, </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">outer =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">line =</span> <span class="sc">-</span><span class="dv">2</span>, </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-con_mort_mat" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-con_mort_mat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="metRegrDemo_files/figure-html/fig-con_mort_mat-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-con_mort_mat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Top-left, species distribution, with every color representing one species. Top-right the matrix of conspecific neighbors. The darker the color, the more conspecific neighbors each focal cell has. Bottom-left, the mortality matrix at generation 90001 assess deaths between generation 90000 and 90001; dark points show deaths, bright points survivors (see next chapter for detials). Bottom-right, the mortality matrix at generation 90000 assess deaths between generation 89101 and 90000; uniform matrix means that only deaths occured: the interval is to big to enable any survivor.
</figcaption>
</figure>
</div>
</div>
</div>
<p>To better understand how data is sampled with respect to time (i.e., how generations are set) we do an excursion.</p>
<section id="generations-and-censii" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="generations-and-censii"><span class="header-section-number">2.2.1</span> Generations and censii</h3>
<p>HÃ¼lsmann et al.&nbsp;(2024) use dynamic data for their analysis, meaning that the same plot is re-measured after a certain periodâapproximately five years in their study. Each measurement is referred to as a census. Only plots with at least one re-measurement were included. Between the measurements for each species the probability of mortality was analyzed with respect to conspecific neighbors.</p>
<p>I adopt a similar approach for my simulated data. I assess the simulation landscape every <span class="math inline">\(n\)</span> generations. Unlike the empirical approach, I analyze mortality changes at only the subsequent generation <span class="math inline">\(n+1\)</span>. Together, <span class="math inline">\(n\)</span> and <span class="math inline">\(n+1\)</span> form a <em>set</em> of censuses, representing a single data unit. Different sets of censuses are independent, as <span class="math inline">\(n\)</span> is chosen large enough to fully reshuffle the landscape matrix. Thus, one generation interval in the simulation is analogous to the five-year interval in the empirical data. The assessed generations in the current dataset are shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from the first run in the batch get the Model parameter, specifically, the runs at which results are recorded</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(runsRaw[[<span class="dv">1</span>]]<span class="sc">$</span>Model<span class="sc">$</span>runs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  900  901 1800 1801 2700 2701</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(runsRaw[[<span class="dv">1</span>]]<span class="sc">$</span>Model<span class="sc">$</span>runs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 88200 88201 89100 89101 90000 90001</code></pre>
</div>
</div>
<p>Now we can better interpret <a href="#fig-con_mort_mat" class="quarto-xref">Figure&nbsp;2</a> (bottom-right). Only a single color is visible because the generations are so far apart that no individual survives between them. Therefore, each set of censuses (<span class="math inline">\(n\)</span> and <span class="math inline">\(n+1\)</span>) can be treated as independent observations, allowing us to apply a simple logit-link function in the binomial GLM. This contrasts with the complementary log-log link used by HÃ¼lsmann et al.&nbsp;(2024), which accounts for a time series of consecutive censuses.</p>
<p>One more detail: we allow the community to reach an equilibrium, which is visually assessed here. We discard earlier generations and analyze only those starting from the equilibrium. We assess the equilibtrium by checking the species richness in the community.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>example <span class="ot">&lt;-</span> <span class="fu">list</span>(runsCon[[<span class="dv">1</span>]],runsCon[[<span class="dv">43</span>]]) <span class="co"># pick only two, otherwise plots occupy to much space</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(example) <span class="ot">&lt;-</span> <span class="st">"PhylosimList"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">getSpecTime</span>(example, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">title =</span> <span class="fu">c</span>(<span class="st">"run 1"</span>, <span class="st">"run 43"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Run 43 clearly demonstrates that the community must reach equilibrium over time. We discard all non-equilibrium periods by generously removing half of the runs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>runsConEq <span class="ot">&lt;-</span> <span class="fu">lapply</span>(runsCon, <span class="cf">function</span>(x){</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>Output <span class="ot">&lt;-</span> x<span class="sc">$</span>Output[<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>] <span class="co"># discard matrices</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>Model<span class="sc">$</span>runs <span class="ot">&lt;-</span> x<span class="sc">$</span>Model<span class="sc">$</span>runs[<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>] <span class="co"># reduce generations (only resembles parameter settings, but used for naming)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(runsConEq) <span class="ot">&lt;-</span> <span class="st">"PhylosimList"</span> <span class="co"># is needed for S3 functions</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>example <span class="ot">&lt;-</span> <span class="fu">list</span>(runsConEq[[<span class="dv">1</span>]],runsConEq[[<span class="dv">43</span>]])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(example) <span class="ot">&lt;-</span> <span class="st">"PhylosimList"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">getSpecTime</span>(example, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">title =</span> <span class="fu">c</span>(<span class="st">"run 1"</span>, <span class="st">"run 43"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now that the pre-equilibrium generations have been discarded, we can convert the matrices into tabular data.</p>
</section>
</section>
<section id="converting-matrices-to-tabular-data" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="converting-matrices-to-tabular-data"><span class="header-section-number">2.3</span> Converting matrices to tabular data</h2>
<p>Next, we convert the matrix data into tabular data with the <code>PhyloSim::getMatToTab()</code> function. With the argument <code>detailedParams = TRUE</code> we include the parameter settings as separate columns. We save the tabular data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert matrices to tabular data. This is done parallel, as it takes longer</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">length</span>(runsCon))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterExport</span>(cl, <span class="fu">c</span>(<span class="st">"getMatToTab"</span>, <span class="st">"runsCon"</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(<span class="at">cl =</span> cl, <span class="at">X =</span> runsCon, <span class="at">fun =</span> <span class="cf">function</span>(x) <span class="fu">getMatToTab</span>(x, <span class="at">detailedParams =</span> <span class="cn">TRUE</span>))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we delete every second generation. Remember, we calculated moralities that happened between <span class="math inline">\(n\)</span> and <span class="math inline">\(n+1\)</span>. The resulting matrix was stored in <span class="math inline">\(n\)</span>. Therefore, <span class="math inline">\(n+1\)</span> is no longer needed and discarded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">lapply</span>(tabRaw, <span class="cf">function</span>(x){</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(census <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tab[[<span class="dv">1</span>]]) <span class="co"># first run in batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  census   indId specId mortNextGen con abund       pDD       nDD   pDDVar
1  45900 1654785  88400       FALSE  46   211 0.7311996 0.7231072 1.836139
2  45900 1654786  57171       FALSE  12  1513 0.7311996 0.7231072 1.836139
3  45900 1654787  88407       FALSE   8   236 0.7311996 0.7231072 1.836139
4  45900 1654788  88407       FALSE   9   236 0.7311996 0.7231072 1.836139
5  45900 1654789  88407       FALSE   7   236 0.7311996 0.7231072 1.836139
6  45900 1654790  57171       FALSE  32  1513 0.7311996 0.7231072 1.836139
    nDDVar pDC nDC
1 14.13058   2   2
2 14.13058   2   2
3 14.13058   2   2
4 14.13058   2   2
5 14.13058   2   2
6 14.13058   2   2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(tab[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       census   indId specId mortNextGen con abund       pDD       nDD   pDDVar
819195  90000 3276795 146921       FALSE  33  1941 0.7311996 0.7231072 1.836139
819196  90000 3276796 154140        TRUE  15  2121 0.7311996 0.7231072 1.836139
819197  90000 3276797 146921       FALSE  33  1941 0.7311996 0.7231072 1.836139
819198  90000 3276798 146921        TRUE  32  1941 0.7311996 0.7231072 1.836139
819199  90000 3276799 175542       FALSE   6    22 0.7311996 0.7231072 1.836139
819200  90000 3276800 146921        TRUE  22  1941 0.7311996 0.7231072 1.836139
         nDDVar pDC nDC
819195 14.13058   2   2
819196 14.13058   2   2
819197 14.13058   2   2
819198 14.13058   2   2
819199 14.13058   2   2
819200 14.13058   2   2</code></pre>
</div>
</div>
<p>We now have tabular data, where the columns are abbreviations. Their full meanings are: individual ID, species ID, mortality in the next generation (<span class="math inline">\(n+1\)</span>), number of conspecific neighbors, species abundance, pDD/nDD strength (&gt;0:1), pDD/nDD specificity parameter (denoted as Var, &gt;0:20), and the radius used for the spatial kernel (pDC/nDC,&gt;0). Note that Var is equivalent to specificity; the different name is a remnant from previous terminology. The n/pDDVar value is used as lambda in the exponential function that defines the specificity kernel.</p>
</section>
</section>
<section id="statistical-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Statistical analysis</h1>
<section id="data-preparation" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">3.1</span> Data preparation</h2>
<p>To assess the relationship between species abundance and stabilizing CDD, I split the tabular data from each run into smaller datasets, each containing all observations for a single species. While I could use the species ID for splitting, there is a possibility that the same species survives across distant censuses. To ensure that each dataset corresponds to the same species within a single census, I append the generation number (= census) to the species ID. Species with fewer than 100 individuals are filtered out to improve statistical robustness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> <span class="fu">length</span>(tab)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(cores)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(cl, {</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>tabS <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(cl, tab, <span class="cf">function</span>(x) {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(abund <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">specIdCen =</span> <span class="fu">paste0</span>(specId, census)) <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>indId) <span class="co"># not needed here</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To quantify stabilizing CDD, I assess the effect of a single conspecific neighbor on an individualâs mortality. For this, I run species-wise binomial GLMs, using mortality status as the response and the number of conspecific neighbors as the predictor. I then extract the model coefficients (intercept and conspecific neighbor coefficient) along with the variance-covariance matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> <span class="fu">length</span>(tab)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(cores)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>mcS_err <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(cl, tabS, <span class="cf">function</span>(x) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  specIDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(x<span class="sc">$</span>specIdCen) <span class="co"># looping through all species within one census</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(specIDs))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (sID <span class="cf">in</span> specIDs) {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> x[x<span class="sc">$</span>specIdCen <span class="sc">==</span> sID, ]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(mortNextGen <span class="sc">~</span> con, <span class="at">data =</span> dat, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    sfm <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod)<span class="sc">$</span>coefficients <span class="co"># extract coefficients</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    vc <span class="ot">&lt;-</span> <span class="fu">vcov</span>(mod)[<span class="fu">c</span>(<span class="st">"(Intercept)"</span>, <span class="st">"con"</span>), <span class="fu">c</span>(<span class="st">"(Intercept)"</span>, <span class="st">"con"</span>)] <span class="co"># extract variance-covariance matrix</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    res[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">specId =</span> sID, <span class="co"># keep species ID in the new data format</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">abund =</span> dat<span class="sc">$</span>abund[<span class="dv">1</span>], <span class="co"># and species abundance</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">coef =</span> <span class="fu">coef</span>(mod)[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)],</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">vcov =</span> vc</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop the cluster</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting data contains species wise information with its abundance, the coefficients and the variance-covariance matrix of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mcS_err[[<span class="dv">1</span>]])[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="co"># first run in batch, first and second species within this run</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$specId
[1] "8840045900"

[[1]]$abund
[1] 211

[[1]]$coef
(Intercept)         con 
-0.45847382 -0.01099499 

[[1]]$vcov
             (Intercept)           con
(Intercept)  0.100201782 -2.334804e-03
con         -0.002334804  7.025949e-05


[[2]]
[[2]]$specId
[1] "5717145900"

[[2]]$abund
[1] 1513

[[2]]$coef
(Intercept)         con 
-0.83990484 -0.00213756 

[[2]]$vcov
              (Intercept)           con
(Intercept)  0.0182698061 -4.353214e-04
con         -0.0004353214  1.260538e-05</code></pre>
</div>
</div>
<p>The next code estimates the variance of the marginal effect of a conspecific neighbor on mortality using a posterior simulation (Tutorial et al.&nbsp;XXXX). It simulates 100 draws of the GLM coefficients from their multivariate normal distribution, computes predicted <em>stabilizing CDD</em> by averaging through all simulations, and additionally computes the standard error, and 95% intervals. This is necessary for a binomial GLM because the logit coefficients are non-linear on the probability scale, so simulating captures the true effect and its uncertainty.</p>
<p>To compute the predicted mortality probabilities, I first calculate the survival probability under the intercept scenario, representing the baseline probability for an individual without any additional conspecific neighbors. Next, I calculate the survival probability for one extra conspecific neighbor. The difference between these two probabilities corresponds to the change in survival probability per additional conspecific neighbor, which is used to quantify stabilizing CDD as defined in HÃ¼lsmann et al.&nbsp;(2024).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> <span class="fu">length</span>(mcS_err)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(cores)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>mcS_err_sim <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(cl, mcS_err, <span class="cf">function</span>(x){</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(x, <span class="cf">function</span>(y){</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    sim <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">mu =</span> <span class="fu">c</span>(y<span class="sc">$</span>coef[<span class="dv">1</span>], y<span class="sc">$</span>coef[<span class="dv">2</span>]), <span class="at">Sigma =</span> y<span class="sc">$</span>vcov)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    mort0 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(sim[, <span class="dv">1</span>])</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    mort1 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(sim[, <span class="dv">1</span>] <span class="sc">+</span> sim[, <span class="dv">2</span>])</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    mort_diff <span class="ot">&lt;-</span> mort1 <span class="sc">-</span> mort0</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">abund =</span> y<span class="sc">$</span>abund,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">specId =</span> y<span class="sc">$</span>specId,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">mean</span>(mort_diff), <span class="co"># averaging of mean effect size</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">se =</span> <span class="fu">sd</span>(mort_diff),</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">ci_low =</span> <span class="fu">quantile</span>(mort_diff, <span class="fl">0.025</span>),</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">ci_high =</span> <span class="fu">quantile</span>(mort_diff, <span class="fl">0.975</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop the cluster</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the coefficients and the variances-covariance matrix we simulated and averaged stabilizing CDD with its standard error and 95% intervals (ci_low and ci_high).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mcS_err_sim[[<span class="dv">1</span>]]) <span class="co"># first run in batch, first six species</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
     abund     specId         mean          se       ci_low      ci_high
2.5%   211 8840045900 -0.002505548 0.001848471 -0.006046942 0.0007562205

[[2]]
     abund     specId          mean           se       ci_low      ci_high
2.5%  1513 5717145900 -0.0005224779 0.0008828653 -0.002097644 0.0008879877

[[3]]
     abund     specId         mean          se       ci_low     ci_high
2.5%   236 8840745900 0.0006282622 0.001985027 -0.003785081 0.003273112

[[4]]
     abund     specId         mean          se      ci_low     ci_high
2.5%   250 8947045900 0.0001496342 0.002283054 -0.00511769 0.003392735

[[5]]
     abund     specId         mean          se       ci_low     ci_high
2.5%   417 8762345900 -0.001693225 0.002435478 -0.006306138 0.002743931

[[6]]
     abund     specId         mean          se       ci_low      ci_high
2.5%   492 8101245900 -0.002123789 0.001527101 -0.005718139 0.0004285285</code></pre>
</div>
</div>
<p>Then, I flatten the nested simulation results into single data frames per run and add a column with the log-transformed species abundance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(mcS_err_sim, <span class="cf">function</span>(group) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind, group)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(m4, <span class="cf">function</span>(group) {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">row.names</span>(group) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  group <span class="ot">&lt;-</span> group <span class="sc">%&gt;%</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">log_N =</span> <span class="fu">log</span>(abund))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(group)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like <code>mcS_err_sim</code>but flattened.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(m4[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  abund     specId          mean           se       ci_low      ci_high
1   211 8840045900 -0.0025055485 0.0018484712 -0.006046942 0.0007562205
2  1513 5717145900 -0.0005224779 0.0008828653 -0.002097644 0.0008879877
3   236 8840745900  0.0006282622 0.0019850274 -0.003785081 0.0032731125
4   250 8947045900  0.0001496342 0.0022830542 -0.005117690 0.0033927354
5   417 8762345900 -0.0016932249 0.0024354778 -0.006306138 0.0027439312
6   492 8101245900 -0.0021237887 0.0015271005 -0.005718139 0.0004285285
     log_N
1 5.351858
2 7.321850
3 5.463832
4 5.521461
5 6.033086
6 6.198479</code></pre>
</div>
</div>
<p>In another preparatory step the data is converted to an escalc object, needed for the meta regression via the <code>metafor::escalc()</code> function, with species ID as the study label. <code>measure = "GEN"</code> implies that effect size (yi) and its variance (sei) are already calculated and supplied to the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>dat_meta <span class="ot">&lt;-</span> <span class="fu">lapply</span>(m4, <span class="cf">function</span>(x) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">escalc</span>(<span class="at">measure =</span> <span class="st">"GEN"</span>, <span class="at">yi =</span> mean, <span class="at">sei =</span> se, <span class="at">slab =</span> specId, <span class="at">data =</span> x)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Same as before but as escalc object</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dat_meta[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>] <span class="co"># somehow head() doesnt work on escalc objects</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  abund     specId          mean           se       ci_low      ci_high 
1   211 8840045900 -0.0025055485 0.0018484712 -0.006046942 0.0007562205 
2  1513 5717145900 -0.0005224779 0.0008828653 -0.002097644 0.0008879877 
3   236 8840745900  0.0006282622 0.0019850274 -0.003785081 0.0032731125 
4   250 8947045900  0.0001496342 0.0022830542 -0.005117690 0.0033927354 
5   417 8762345900 -0.0016932249 0.0024354778 -0.006306138 0.0027439312 
6   492 8101245900 -0.0021237887 0.0015271005 -0.005718139 0.0004285285 
     log_N 
1 5.351858 
2 7.321850 
3 5.463832 
4 5.521461 
5 6.033086 
6 6.198479 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(dat_meta[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "escalc"     "data.frame"</code></pre>
</div>
</div>
<p>This code fits a <strong>meta regression</strong> model for each dataset in parallel. For each species, it fits a meta-regression model <code>metafor::rma()</code> with log_N as a moderator, meaning the model tests whether stabilizing CDD varies systematically with species abundance. In case the model fails for some runs, I build a tryCatch mechanisms that excludes this failed run from the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">length</span>(dat_meta))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterExport</span>(cl, <span class="at">varlist =</span> <span class="fu">c</span>(<span class="st">"dat_meta"</span>), <span class="at">envir =</span> <span class="fu">environment</span>())</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>metamod <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(cl, dat_meta, <span class="cf">function</span>(x) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    metafor<span class="sc">::</span><span class="fu">rma</span>(</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">yi =</span> yi,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">vi =</span> vi,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">mods =</span> <span class="sc">~</span> log_N,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"REML"</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> x</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)  <span class="co"># Return NULL for failed models</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NULL elements and keep names aligned</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>failed_indices <span class="ot">&lt;-</span> <span class="fu">sapply</span>(metamod, is.null)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>namesShort <span class="ot">&lt;-</span> <span class="fu">names</span>(metamod)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>metamod <span class="ot">&lt;-</span> metamod[<span class="sc">!</span>failed_indices]</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(metamod) <span class="ot">&lt;-</span> namesShort[<span class="sc">!</span>failed_indices]</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Report which models failed</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(failed_indices)) {</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Failed models:"</span>, <span class="fu">paste</span>(namesShort[failed_indices], <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="visualize-results" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Visualize results</h1>
<p>After fitting the model, we run predictions and visualize the results. First we compute predictions based on the datmeta (escalc) object with a sequence of newly predicted log-abundance (log_N) values as new moderators, according to the fitted rma.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">lapply</span>(dat_meta, <span class="cf">function</span>(x){</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">log_N =</span> <span class="fu">seq</span>(<span class="fu">min</span>(x<span class="sc">$</span>log_N, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">max</span>(x<span class="sc">$</span>log_N, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">length.out =</span> <span class="dv">1000</span>))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">lapply</span>(pred, <span class="cf">function</span>(x){</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>abund <span class="ot">&lt;-</span> <span class="fu">exp</span>(x<span class="sc">$</span>log_N)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(pred), <span class="cf">function</span>(i){</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> pred[[i]]</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> metamod[[i]]</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(x, <span class="fu">predict</span>(<span class="at">object =</span> y, <span class="at">newmods =</span> x<span class="sc">$</span>log_N))</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pred) <span class="ot">&lt;-</span> <span class="fu">names</span>(metamod)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because I am interested in the relationship between stabilizing CDD and species abundance, I extract the slope from the meta-regression model. A more negative slope indicates a stronger negative relationship, while a slope of 0 indicates no relationship. Additionally, I extract species abundance, the coefficient of variation (CV = SD / mean), and mean species richness (SR). The SR is averaged after filtering out non-equilibrium generations (see Assessing conspecific neighbors and mortalities).</p>
<p>Finally, I filter the results by different spatial kernels to verify that the applied GLMâwith an increased neighborhood radius even where DD acted within a smaller kernel (see The spatial kernel)âproduces valid results across all parameter settings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(runsCon) <span class="ot">&lt;-</span> <span class="fu">names</span>(dat_meta)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>srRaw <span class="ot">&lt;-</span> <span class="fu">getSpecTime</span>(runsCon, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get slopes</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(metamod, <span class="sc">~</span> <span class="fu">coef</span>(.x)[<span class="dv">2</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"param"</span>, <span class="at">value =</span> <span class="st">"slope"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get abundance (use max to exclude extreme values)</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>abund <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(dat_meta, <span class="sc">~</span> <span class="fu">max</span>(.x<span class="sc">$</span>abund)) <span class="sc">%&gt;%</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"param"</span>, <span class="at">value =</span> <span class="st">"abund"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get CV of predictions</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>cv <span class="ot">&lt;-</span> <span class="fu">map</span>(pred, <span class="sc">~</span> {</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  meanMC <span class="ot">&lt;-</span> <span class="fu">mean</span>(.x<span class="sc">$</span>pred)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  sdMC <span class="ot">&lt;-</span> <span class="fu">sd</span>(.x<span class="sc">$</span>pred)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  rangeMC <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">range</span>(.x<span class="sc">$</span>pred))</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">meanMC =</span> meanMC, <span class="at">sdMC =</span> sdMC, <span class="at">rangeMC =</span> rangeMC, <span class="at">cvMC =</span> sdMC <span class="sc">/</span> meanMC)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"param"</span>)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Get species richness summary</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>sr <span class="ot">&lt;-</span> <span class="fu">map</span>(srRaw, <span class="sc">~</span> {</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  vals <span class="ot">&lt;-</span> .x<span class="sc">$</span>spec_rich[<span class="dv">99</span><span class="sc">:</span><span class="dv">200</span>]</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanSR =</span> <span class="fu">mean</span>(vals),</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">sdSR =</span> <span class="fu">sd</span>(vals),</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">medianSR =</span> <span class="fu">median</span>(vals)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"param"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">medianSR =</span> <span class="fu">as.integer</span>(medianSR))</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all results</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">list</span>(slope, sr, abund, cv) <span class="sc">%&gt;%</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">"param"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">abund =</span> <span class="fu">as.integer</span>(abund))</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter by scenario types</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>scenario_types <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">prefix =</span> <span class="fu">c</span>(<span class="st">"P"</span>, <span class="st">"N"</span>), <span class="at">comp =</span> <span class="fu">paste0</span>(<span class="st">"C"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>res_scenarios <span class="ot">&lt;-</span> <span class="fu">map2</span>(scenario_types<span class="sc">$</span>prefix, scenario_types<span class="sc">$</span>comp, <span class="sc">~</span> {</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>  pattern <span class="ot">&lt;-</span> <span class="cf">if</span> (.x <span class="sc">==</span> <span class="st">"P"</span>) <span class="fu">paste0</span>(.x, <span class="st">".*-"</span>, .y, <span class="st">"_"</span>) <span class="cf">else</span> <span class="fu">paste0</span>(.x, <span class="st">".*-"</span>, .y, <span class="st">"$"</span>)</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>  res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">grepl</span>(pattern, param))</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste0</span>(scenario_types<span class="sc">$</span>prefix, scenario_types<span class="sc">$</span>comp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- helper functions ----</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>pred_lm_log <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, newdata, <span class="at">k =</span> <span class="dv">2</span>) {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> newdata, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">exp</span>(pred<span class="sc">$</span>fit)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  lo  <span class="ot">&lt;-</span> <span class="fu">exp</span>(pred<span class="sc">$</span>fit <span class="sc">-</span> k<span class="sc">*</span>pred<span class="sc">$</span>se.fit)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  hi  <span class="ot">&lt;-</span> <span class="fu">exp</span>(pred<span class="sc">$</span>fit <span class="sc">+</span> k<span class="sc">*</span>pred<span class="sc">$</span>se.fit)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">fit =</span> fit, <span class="at">lo =</span> lo, <span class="at">hi =</span> hi)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to format p-values</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>format_pvalue <span class="ot">&lt;-</span> <span class="cf">function</span>(p) {</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.001</span>) {</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"p &lt; 0.001"</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (p <span class="sc">&lt;</span> <span class="fl">0.01</span>) {</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sprintf</span>(<span class="st">"p = %.3f"</span>, p))</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">sprintf</span>(<span class="st">"p = %.2f"</span>, p))</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Unified function for species richness vs slope plot</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>plot_sr_slope <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, tag, <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">100</span>)) {</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  fm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanSR <span class="sc">~</span> slope, <span class="at">data =</span> dat)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  newdat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">slope =</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>slope), <span class="fu">max</span>(dat<span class="sc">$</span>slope), <span class="at">length =</span> <span class="dv">100</span>))</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  predi <span class="ot">&lt;-</span> <span class="fu">predict</span>(fm1, <span class="at">newdata =</span> newdat, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract p-value</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  p_val <span class="ot">&lt;-</span> <span class="fu">summary</span>(fm1)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>]  <span class="co"># p-value for slope coefficient</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  p_text <span class="ot">&lt;-</span> <span class="fu">format_pvalue</span>(p_val)</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(dat<span class="sc">$</span>slope, dat<span class="sc">$</span>meanSR, <span class="at">ylim =</span> ylim_sr, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"blue"</span>,</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"slope"</span>, <span class="at">ylab =</span> <span class="st">"mean species richness"</span>)</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(dat<span class="sc">$</span>slope, dat<span class="sc">$</span>medianSR, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrows</span>(dat<span class="sc">$</span>slope, dat<span class="sc">$</span>meanSR <span class="sc">-</span> dat<span class="sc">$</span>sdSR, dat<span class="sc">$</span>slope, dat<span class="sc">$</span>meanSR <span class="sc">+</span> dat<span class="sc">$</span>sdSR,</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">code =</span> <span class="dv">3</span>, <span class="at">length =</span> <span class="fl">0.05</span>)</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>slope, predi<span class="sc">$</span>fit, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>slope, predi<span class="sc">$</span>fit <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>predi<span class="sc">$</span>se.fit, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>slope, predi<span class="sc">$</span>fit <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>predi<span class="sc">$</span>se.fit, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"mean SR"</span>, <span class="st">"median SR"</span>, <span class="st">"fitted lm"</span>, <span class="st">"CI"</span>),</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">16</span>,<span class="dv">16</span>,<span class="cn">NA</span>,<span class="cn">NA</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add p-value text</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(<span class="at">x =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), </span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">4</span>] <span class="sc">-</span> <span class="fl">0.05</span> <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]), </span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">labels =</span> p_text, <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="at">col =</span> <span class="st">"darkred"</span>)</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Unified function for abundance vs slope plot (now using log transform and lm)</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>plot_abund_slope <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, tag) {</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log-transform abundance (add 1 to avoid log(0))</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>  dat<span class="sc">$</span>log_abund <span class="ot">&lt;-</span> <span class="fu">log</span>(dat<span class="sc">$</span>abund)</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit linear model on log(abundance)</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_abund <span class="sc">~</span> slope, <span class="at">data =</span> dat)</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prediction along slope range</span></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>  newdat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">slope =</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>slope), <span class="fu">max</span>(dat<span class="sc">$</span>slope), <span class="at">length =</span> <span class="dv">100</span>))</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>  pg <span class="ot">&lt;-</span> <span class="fu">pred_lm_log</span>(fm, newdat, <span class="at">k =</span> <span class="dv">2</span>)</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract p-value for slope</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>  p_val <span class="ot">&lt;-</span> <span class="fu">summary</span>(fm)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>]</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>  p_text <span class="ot">&lt;-</span> <span class="fu">format_pvalue</span>(p_val)</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot log-transformed abundances</span></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(dat<span class="sc">$</span>slope, dat<span class="sc">$</span>log_abund, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="dv">1</span>,</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"slope"</span>, <span class="at">ylab =</span> <span class="st">"log(max abundance)"</span>)</span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add fitted line and confidence intervals</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>slope, <span class="fu">log</span>(pg<span class="sc">$</span>fit), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>slope, <span class="fu">log</span>(pg<span class="sc">$</span>lo), <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>slope, <span class="fu">log</span>(pg<span class="sc">$</span>hi), <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add legend</span></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"fitted lm"</span>, <span class="st">"CI"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add p-value text</span></span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(<span class="at">x =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.75</span><span class="sc">*</span><span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">4</span>] <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">*</span><span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]),</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>       <span class="at">labels =</span> p_text, <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="at">col =</span> <span class="st">"darkred"</span>)</span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Unified function for species richness vs CV mortality change</span></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>plot_sr_cvmc <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, tag, <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">90</span>)) {</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>  fm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanSR <span class="sc">~</span> cvMC, <span class="at">data =</span> dat)</span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>  newdat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cvMC =</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>cvMC), <span class="fu">max</span>(dat<span class="sc">$</span>cvMC), <span class="at">length =</span> <span class="dv">100</span>))</span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fm3, <span class="at">newdata =</span> newdat, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract p-value</span></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>  p_val <span class="ot">&lt;-</span> <span class="fu">summary</span>(fm3)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>]  <span class="co"># p-value for cvMC coefficient</span></span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>  p_text <span class="ot">&lt;-</span> <span class="fu">format_pvalue</span>(p_val)</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">viridis</span>(<span class="fu">length</span>(dat<span class="sc">$</span>slope))[<span class="fu">rank</span>(dat<span class="sc">$</span>slope)]</span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(dat<span class="sc">$</span>cvMC, dat<span class="sc">$</span>meanSR, <span class="at">ylim =</span> ylim_sr, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> cols,</span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"CV of stabilizing CDD"</span>, <span class="at">ylab =</span> <span class="st">"mean species richness"</span>)</span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrows</span>(dat<span class="sc">$</span>cvMC, dat<span class="sc">$</span>meanSR <span class="sc">-</span> dat<span class="sc">$</span>sdSR, dat<span class="sc">$</span>cvMC, dat<span class="sc">$</span>meanSR <span class="sc">+</span> dat<span class="sc">$</span>sdSR,</span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>         <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">code =</span> <span class="dv">3</span>, <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> cols)</span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>cvMC, pred<span class="sc">$</span>fit, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>cvMC, pred<span class="sc">$</span>fit <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>pred<span class="sc">$</span>se.fit, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>cvMC, pred<span class="sc">$</span>fit <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>pred<span class="sc">$</span>se.fit, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">title =</span> <span class="st">"slope"</span>,</span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="fu">viridis</span>(<span class="dv">5</span>),</span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>         <span class="at">legend =</span> <span class="fu">signif</span>(<span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>slope), <span class="fu">max</span>(dat<span class="sc">$</span>slope), <span class="at">length.out =</span> <span class="dv">5</span>), <span class="dv">2</span>),</span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a>         <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> .<span class="dv">8</span>)</span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add p-value text</span></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(<span class="at">x =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.02</span> <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), </span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">4</span>] <span class="sc">-</span> <span class="fl">0.05</span> <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]), </span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a>       <span class="at">labels =</span> p_text, <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="at">col =</span> <span class="st">"darkred"</span>)</span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Unified function for species richness vs mean stabilizing CDD</span></span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a>plot_sr_meanmc <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, tag, <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">90</span>)) {</span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>  fm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanSR <span class="sc">~</span> meanMC, <span class="at">data =</span> dat)</span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>  newdat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">meanMC =</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>meanMC), <span class="fu">max</span>(dat<span class="sc">$</span>meanMC), <span class="at">length =</span> <span class="dv">100</span>))</span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fm4, <span class="at">newdata =</span> newdat, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract p-value</span></span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>  p_val <span class="ot">&lt;-</span> <span class="fu">summary</span>(fm4)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">4</span>]  <span class="co"># p-value for log(meanMC) coefficient</span></span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>  p_text <span class="ot">&lt;-</span> <span class="fu">format_pvalue</span>(p_val)</span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">viridis</span>(<span class="fu">length</span>(dat<span class="sc">$</span>slope))[<span class="fu">rank</span>(dat<span class="sc">$</span>slope)]</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(dat<span class="sc">$</span>meanMC, dat<span class="sc">$</span>meanSR, <span class="at">ylim =</span> ylim_sr, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> cols,</span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab =</span> <span class="st">"mean stabilizing CDD (%)"</span>, <span class="at">ylab =</span> <span class="st">"mean species richness"</span>)</span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>meanMC, pred<span class="sc">$</span>fit, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>meanMC, pred<span class="sc">$</span>fit <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>pred<span class="sc">$</span>se.fit, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(newdat<span class="sc">$</span>meanMC, pred<span class="sc">$</span>fit <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>pred<span class="sc">$</span>se.fit, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">title =</span> <span class="st">"slope"</span>,</span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="fu">viridis</span>(<span class="dv">5</span>),</span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a>         <span class="at">legend =</span> <span class="fu">signif</span>(<span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>slope), <span class="fu">max</span>(dat<span class="sc">$</span>slope), <span class="at">length.out =</span> <span class="dv">5</span>), <span class="dv">2</span>),</span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a>         <span class="at">bty =</span> <span class="st">"n"</span>, <span class="at">cex =</span> .<span class="dv">8</span>)</span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"fitted lm"</span>, <span class="st">"CI"</span>),</span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a>         <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add p-value text</span></span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(<span class="at">x =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), </span>
<span id="cb39-130"><a href="#cb39-130" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">4</span>] <span class="sc">-</span> <span class="fl">0.05</span> <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]), </span>
<span id="cb39-131"><a href="#cb39-131" aria-hidden="true" tabindex="-1"></a>       <span class="at">labels =</span> p_text, <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="at">col =</span> <span class="st">"darkred"</span>)</span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Master plotting function for all scenario plots (4 plot types per scenario)</span></span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a>plot_all_scenarios <span class="ot">&lt;-</span> <span class="cf">function</span>(scenario_list, scenario_names, </span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a>                              <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">100</span>)) {</span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a>  n_scenarios <span class="ot">&lt;-</span> <span class="fu">length</span>(scenario_list)</span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each scenario, create all 4 plot types</span></span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_scenarios) {</span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up 2x2 grid for each scenario with main title</span></span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Main analysis plots</span></span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_sr_slope</span>(scenario_list[[i]], scenario_names[i], ylim_sr)</span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_abund_slope</span>(scenario_list[[i]], scenario_names[i])</span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_sr_cvmc</span>(scenario_list[[i]], scenario_names[i], ylim_sr)</span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_sr_meanmc</span>(scenario_list[[i]], scenario_names[i], ylim_sr)</span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add main title for the entire 4-panel plot</span></span>
<span id="cb39-151"><a href="#cb39-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(scenario_names[i], <span class="at">outer =</span> <span class="cn">TRUE</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">font =</span> <span class="dv">2</span>)</span>
<span id="cb39-152"><a href="#cb39-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-153"><a href="#cb39-153" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-154"><a href="#cb39-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-155"><a href="#cb39-155" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- apply to scenarios C1-C5 ----</span></span>
<span id="cb39-156"><a href="#cb39-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming you have data objects: resC1, resC2, resC3, resC4, resC5</span></span>
<span id="cb39-157"><a href="#cb39-157" aria-hidden="true" tabindex="-1"></a>scenario_dataP <span class="ot">&lt;-</span> res_scenarios[<span class="fu">str_detect</span>(<span class="at">string =</span> <span class="fu">names</span>(res_scenarios),<span class="at">pattern =</span> <span class="st">"P"</span>)]</span>
<span id="cb39-158"><a href="#cb39-158" aria-hidden="true" tabindex="-1"></a>scenario_labelsP <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pDC = 1"</span>,<span class="st">"pDC = 2"</span>, <span class="st">"pDC = 3"</span>,<span class="st">"pDC = 4"</span>, <span class="st">"pDC = 5"</span>)</span>
<span id="cb39-159"><a href="#cb39-159" aria-hidden="true" tabindex="-1"></a>scenario_dataN <span class="ot">&lt;-</span> res_scenarios[<span class="fu">str_detect</span>(<span class="at">string =</span> <span class="fu">names</span>(res_scenarios),<span class="at">pattern =</span> <span class="st">"N"</span>)]</span>
<span id="cb39-160"><a href="#cb39-160" aria-hidden="true" tabindex="-1"></a>scenario_labelsN <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"nDC = 1"</span>,<span class="st">"nDC = 2"</span>, <span class="st">"nDC = 3"</span>,<span class="st">"nDC = 4"</span>, <span class="st">"nDC = 5"</span>)</span>
<span id="cb39-161"><a href="#cb39-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-162"><a href="#cb39-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all plots for negative scenarios</span></span>
<span id="cb39-163"><a href="#cb39-163" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_all_scenarios</span>(scenario_dataN, scenario_labelsN,</span>
<span id="cb39-164"><a href="#cb39-164" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-2.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-3.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-4.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-5.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate all plots for positive scenarios (fixed label bug)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_all_scenarios</span>(scenario_dataP, scenario_labelsP,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-6.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-7.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-8.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-9.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-10.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate plot for combined data</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_all_scenarios</span>(<span class="fu">list</span>(res), <span class="st">"combined data"</span>, </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-26-11.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data is sorted by nDD spatial kernel (= nDC) and pdd(= pDC). The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
</div>
<p>I analyzed 50 random runs here and repeated the same procedure for 100 additional runs. Next, we load these datasets, combine them, and visualize the results for the full set of runs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>resi <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(root, <span class="st">"/local/runs/mstr/20250903/ranResMax_i.rds"</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>resii <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(root, <span class="st">"/local/runs/mstr/20250903/ranResMax_ii.rds"</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>resiii <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(root, <span class="st">"/local/runs/mstr/20250903/ranResMax_iii.rds"</span>))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>res_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resi,resii,resiii)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate plot for combined data</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_all_scenarios</span>(<span class="fu">list</span>(res_all), <span class="st">"combined data"</span>, </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ylim_sr =</span> <span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="metRegrDemo_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Relationships between stabilizing CDD parameters and community diversity metrics for randomly sampled nDD and pDD scenarios. A linear regression with 95% confidence intervals is fitted for the data in the corresponding panels. Data comes from 150 runs with randomly sampled parametrization. The slope results from the metaregression and encapsulates the relationship between stabilizing CDD and species abundance - the more negative it is, the stronger the negative relationship. Mean species richness is averaged across one run after filtering out non-equilibrium generations. Max abundance is the maximum abundance of any species within one run. CV is the coefficient of variation calculated by standard deviation of stabilizing CDD divided by mean stabilizing CDD. Top-left: Mean species richness vs slope. Top-right: Maximum abundance vs slope with log-transformed model fit. Bottom-left: Mean species richness vs CV stabilizing CDD (%) colored by slope values. Bottom-right: Mean species richness vs mean stabilizing CDD (%) with log-transformed relationship and slope-colored points.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="references" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> References</h1>
<p>HÃ¼lsmann, L., Chisholm, R. A., Comita, L., Visser, M. D., de Souza Leite, M., Aguilar, S., Anderson-Teixeira, K. J., Bourg, N. A., Brockelman, W. Y., Bunyavejchewin, S., CastaÃ±o, N., Chang-Yang, C.-H., Chuyong, G. B., Clay, K., Davies, S. J., Duque, A., Ediriweera, S., Ewango, C., Gilbert, G. S., â¦ Hartig, F. (2024). Latitudinal patterns in stabilizing density dependence of forest communities. Nature, 627(8004), 564â571. https://doi.org/10.1038/s41586-024-07118-4</p>
<p>Krishnadas, M., B. Bachelot, R. Bagchi, et al.&nbsp;In Preparation. âConspecific Density Dependence in Plant Communities: A TheoryBased Toolkit for Empirical Studies.â</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>